<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <title>FARMRKTT Login</title>
    <style>
        /* Your existing styles */
        /* Styles omitted for brevity */
    </style>
</head>
<body>
<div class="wrapper">
    <form id="loginForm" onsubmit="return validateLogin()">
        <h1>FARMRKTT</h1>

        <div class="input-box">
            <input type="text" id="email" placeholder="useremail" required>
            <i class="fa-solid fa-user"></i>
        </div>
        <div id="usernameError" class="error"></div>

        <div class="input-box">
            <input type="password" id="password" placeholder="Password" required>
            <i class="fa-solid fa-lock"></i>
        </div>
        <div id="passwordError" class="error"></div>

        <div class="remember-forgot">
            <label><input type="checkbox">Remember me</label>
            <a href="#">Forgot password?</a>
        </div>

        <button type="submit" class="btn">LOGIN</button>
        <p id="errorMessage" style="color: red;"></p>

        <div class="register-link">
            <p>Don't have an account? <a href="SignUp.html">Register</a></p>
        </div>
    </form>
</div>

<script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function validateLogin() {
        const emailField = document.getElementById('email');
        const passwordField = document.getElementById('password');
        const usernameError = document.getElementById('usernameError');
        const passwordError = document.getElementById('passwordError');
        const errorMessageElement = document.getElementById('errorMessage');

        usernameError.textContent = '';
        passwordError.textContent = '';
        errorMessageElement.textContent = '';

        const email = emailField.value.trim().toLowerCase();
        const password = passwordField.value.trim();

        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailPattern.test(email)) {
            usernameError.textContent = 'Please enter a valid email address.';
            return false;
        }

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;

                // Check if email is verified
                if (!user.emailVerified) {
                    errorMessageElement.textContent = 'Please verify your email before logging in.';
                    auth.signOut(); // Sign out if not verified
                    return;
                }

                // Retrieve user data from Firestore
                return db.collection('users').doc(user.uid).get();
            })
            .then((doc) => {
                if (doc.exists) {
                    localStorage.setItem('loggedInUser', JSON.stringify(doc.data()));
                    window.location.href = 'index.html'; // Redirect to index page
                } else {
                    errorMessageElement.textContent = 'User data not found.';
                }
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                if (errorCode === 'auth/user-not-found') {
                    usernameError.textContent = 'Email not registered. Please sign up first.';
                } else if (errorCode === 'auth/wrong-password') {
                    passwordError.textContent = 'Incorrect password. Please try again.';
                } else {
                    errorMessageElement.textContent = errorMessage;
                }
            });

        return false; // Prevent default form submission
    }
</script>

</body>
</html>